# Bulking Up

In our [last post](http://www.textualdevelopment.com/2015/06/11/you-get-what-you-give/), we learned
how to retrieve a document from Elasticsearch by id.  Most of our Elasticsearch use cases will focus
on _searching_ for documents matching some _criteria_ rather than retrieving them by id.  In our
next post we'll start looking at search, but before doing that we'll need a collection of documents
indexed in Elasticsearch that we can search against.  In this post, we'll look at using the
Elasticsearch Bulk API to efficiently index a large number of documents.



## Bulk REST API

The Elasticsearch bulk API lets us index multiple documents within a single request.  

A bulk indexing request has the following characteristics:

* It consists of an HTTP POST against the `_bulk` REST endpoint.
* The payload of the POST contains one or more instructions for what we'd like indexed.
* Each instruction consists of two lines describing the indexing action to take for a given document.
	* The first line is the action and metadata specification for the request.
	* The second line is the actual source JSON document that we're indexing.

As an example, if we wanted to index the first three [albums]() (500 through 498) from the Rolling
Stone 500, we'd use the following request:

```json
POST /_bulk
{ "index": { "_index": "rolling-stone-500", "_type": "album", "_id": "500" } }
{"title": "Aquemini", "url": "http://www.rollingstone.com/music/lists..." }
{ "index": { "_index": "rolling-stone-500", "_type": "album", "_id": "499" } }
{"title": "Live in Cook County Jail", "url": "http://www.rollingstone..." }
{ "index": { "_index": "rolling-stone-500", "_type": "album", "_id": "498" } }
{"title": "The Stone Roses", "url": "http://www.rollingstone.com/music..."}
```

Let's take a closer look at the first line of the first indexing instruction within the bulk request:

```json
{ "index": { "_index": "rolling-stone-500", "_type": "album", "_id": "500" } }
```

We see the following:

* The top level JSON field, `index`, indicates that this is an indexing instruction.
	* Although we won't cover them in this post, the bulk API also supports `create`, `update`, and `delete` actions.
* The body of the `index` field contains metadata about how to index the document:
	* `_index` indicates that we want the document indexed in the _rolling-stone-500_ index.
	* `_type` indicates that we want the document indexed under the _album_ type.
	* `_id` indicates the document id should be set to _500_.

The second line of the indexing instruction is the full JSON _source_ of the document we're
indexing.  This is similar in structure to the JSON documents we indexed individually in a previous
post, but with one important change:  The bulk API requires that each source JSON document be 
included in the POST body as a single line (with no unescaped newlines.)

After making the above request, we get the following response back:

```json
{
   "took": 82,
   "errors": false,
   "items": [
      {
         "index": {
            "_index": "rolling-stone-500",
            "_type": "album",
            "_id": "500",
            "_version": 1,
            "status": 201
         }
      },
      {
         "index": {
            "_index": "rolling-stone-500",
            "_type": "album",
            "_id": "499",
            "_version": 1,
            "status": 201
         }
      },
      {
         "index": {
            "_index": "rolling-stone-500",
            "_type": "album",
            "_id": "498",
            "_version": 1,
            "status": 201
         }
      }
   ]
}
```

In the response above, we see that no errors were generated (via the _errors_ field), and are also
able to see some details about each of the indexed documents.  Of particular note is the _status_
value -- in this case, the value of _201_ indicating that each document was created as part of this
request.


Let's make a request that will generate an error, to see what we get back.  If we've already indexed
a document where the `year` field was interpreted as an integer, indexing another document with a
value in `year` that can't be parsed as an integer will generate an error:

```json
POST /_bulk
{ "index": { "_index": "rolling-stone-500", "_type": "album", "_id": "499"}}
{ ...  "year": "not an integer" ... }
```

This will generate the following response:

```json
{
   "took": 35,
   "errors": true,
   "items": [
      {
         "index": {
            "_index": "rolling-stone-500",
            "_type": "album",
            "_id": "499",
            "status": 400,
            "error": "MapperParsingException[failed to parse [year]]; nested: NumberFormatException[For input string: \"not an integer\"]; "
         }
      }
   ]
}
```

You'll notice that:

* The `errors` field is now set to _true_.
* The `status` value of the item is set to `400` rather than `201`
* There is a new `error` field on the item, containing some details about the error genereated.

One of the nice things about the bulk API is that it will index the documents that it _can_, while
handling any individual document failures and providing information (as seen above) as to which
documents succeeded and failed, and why.

### Index and Type Shorthand

If _all_ the documents within our bulk request fall under the same index and type, we can take a
'shorthand' approach by including the index and type in the request URL.  By doing this, we make
these the default index and type used in each of the indexing instructions, allowing us to leave
those values out of each individual instruction:

```json
POST /rolling-stone-500/album/_bulk
{ "index": { "_id": "500" } }
{"title": "Aquemini", "url": "http://www.rollingstone.com/music/lists..." }
{ "index": { "_id": "499" } }
{"title": "Live in Cook County Jail", "url": "http://www.rollingstone..." }
{ "index": { "_id": "498" } }
{"title": "The Stone Roses", "url": "http://www.rollingstone.com/music..."}
```

### Rolling Stone 500 - Bulk Script

In preparation for upcoming search work, we'll need to index a 'corpus' of documents to search
against.  We'll be using the following script for that.  Running this scrip via Sense will index
all albums in the Rolling Stone top 500 Albums collection into Elasticsearch.

* [Rolling Stone 500 - Elasticsearch Bulk Load Script](https://gist.github.com/rickhaffey/69c18545d6effe03f3e5#file-rolling-stone-500-es-bulk-load)

## NEST

## Summary

* next post - first search example
